{% extends "base.html" %}
{% load static %}
{% block head_title %}
Sign Up
{% endblock head_title %}
{% block head %}
<style>
  /* Retro form container with SOLID background */
  .retro-form-container {
    border: 3px solid #fec84b;
    border-radius: 6px;
    background: #251809;
    box-shadow:
      inset 0 1px 0 rgba(255, 255, 255, 0.1),
      0 4px 0 rgba(254, 200, 75, 0.3),
      0 8px 30px rgba(0, 0, 0, 0.6);
  }

  /* Retro form buttons */
  .retro-form-btn {
    font-family: 'Press Start 2P', cursive;
    font-size: 0.7rem;
    padding: 0.875rem 1.5rem;
    border: 3px solid currentColor;
    border-radius: 4px;
    box-shadow:
      inset 0 -2px 0 rgba(0, 0, 0, 0.3),
      inset 0 1px 0 rgba(255, 255, 255, 0.2),
      0 4px 0 rgba(0, 0, 0, 0.25);
    transition: all 0.15s;
    text-transform: uppercase;
  }

  .retro-form-btn:hover:not(:disabled) {
    transform: translateY(-1px);
    box-shadow:
      inset 0 -2px 0 rgba(0, 0, 0, 0.3),
      inset 0 1px 0 rgba(255, 255, 255, 0.3),
      0 5px 0 rgba(0, 0, 0, 0.3);
  }

  .retro-form-btn:active {
    transform: translateY(2px);
    box-shadow:
      inset 0 -1px 0 rgba(0, 0, 0, 0.2),
      inset 0 2px 3px rgba(0, 0, 0, 0.3),
      0 2px 0 rgba(0, 0, 0, 0.2);
  }

  .retro-form-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* Step dots */
  .step-dot {
    width: 10px;
    height: 10px;
    border-radius: 2px;
    background: rgba(254, 200, 75, 0.2);
    border: 2px solid rgba(254, 200, 75, 0.3);
    transition: all 0.3s;
  }

  .step-dot.active {
    background: #fec84b;
    border-color: #fec84b;
    box-shadow: 0 0 10px rgba(254, 200, 75, 0.6);
    transform: scale(1.3);
  }

  .retro-form-wrapper input {
    border-color: rgba(221, 207, 181, 0.3) !important;
    font-size: 1rem !important;
  }

  .retro-form-wrapper input:focus {
    border-color: rgba(254, 200, 75, 0.8) !important;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3), 0 0 12px rgba(254, 200, 75, 0.25) !important;
  }
</style>
{% endblock head %}
{% block content %}
<div class="min-h-[90vh] flex items-center justify-center px-4 py-8">
  <div class="w-full max-w-md retro-form-wrapper">
    <div class="retro-form-container p-8">
      <!-- Header -->
      <div class="text-center mb-8">
        <div class="pixel-accent-amber mb-6"></div>
        <div class="flex justify-center mb-4">
          <i class="ph-fill ph-hand-waving text-accent text-4xl crt-glow"></i>
        </div>
        <h1 class="font-pixel text-2xl text-secondary crt-glow mb-2">Join Re-Dcrypt!</h1>
        <p class="retro-text text-light/60 text-sm">
          Already have an account?
          <a href="{% url 'account_login' %}" class="text-primary hover:text-primary/80 font-bold">Login</a>
        </p>
      </div>

      <!-- Signup Form -->
      <form method="post" action="{% url 'account_signup' %}" id="signup_form">
        {% csrf_token %}

        <!-- Step 1: Email -->
        <div class="form-step" data-step="1" data-active="true">
          <div class="space-y-6">
            <div>
              <label for="id_email" class="font-pixel text-xs text-light block mb-2 crt-glow-sm">
                Email
              </label>
              <input type="email" name="email" id="id_email" required placeholder="Enter your email" class="w-full">
            </div>
          </div>

          <button type="button"
            class="retro-form-btn w-full bg-secondary text-dark border-secondary hover:bg-primary hover:border-primary mt-8 flex items-center justify-center gap-3 next-btn">
            <span>Continue</span>
            <i class="ph-bold ph-arrow-right text-sm"></i>
          </button>
        </div>

        <!-- Step 2: Username & Password -->
        <div class="form-step hidden" data-step="2" data-active="false">
          <div class="space-y-6">
            <div>
              <label for="id_username" class="font-pixel text-xs text-light block mb-2 crt-glow-sm">
                Username
              </label>
              <input type="text" name="username" id="id_username" required placeholder="Choose a username"
                class="w-full">
            </div>

            <div>
              <label for="id_password" class="font-pixel text-xs text-light block mb-2 crt-glow-sm">
                Password
              </label>
              <div class="relative">
                <input type="password" name="password1" id="id_password" required placeholder="Create a password"
                  class="w-full pr-12">
                <i class="ph-fill ph-eye cursor-pointer text-lg text-light/40 absolute right-3 top-1/2 -translate-y-1/2 hover:text-accent transition-colors"
                  id="togglePassword"></i>
              </div>
              <p class="text-light/40 text-xs retro-text mt-2">
                Use 8+ characters, uppercase, lowercase & numbers
              </p>
            </div>
          </div>

          <div class="flex gap-4 mt-8">
            <button type="button"
              class="retro-form-btn flex-1 bg-dark text-light border-light bg-opacity-40 hover:bg-opacity-60 flex items-center justify-center gap-2 back-btn">
              <i class="ph-bold ph-arrow-left text-sm"></i>
              <span>Back</span>
            </button>
            <button type="button"
              class="retro-form-btn flex-1 bg-secondary text-dark border-secondary hover:bg-primary hover:border-primary flex items-center justify-center gap-2 next-btn">
              <span>Next</span>
              <i class="ph-bold ph-arrow-right text-sm"></i>
            </button>
          </div>
        </div>

        <!-- Step 3: Profile & Submit -->
        <div class="form-step hidden" data-step="3" data-active="false">
          <div class="space-y-6">
            <div>
              <label for="id_name" class="font-pixel text-xs text-light block mb-2 crt-glow-sm">
                Full Name <span class="text-light/40">(Optional)</span>
              </label>
              <input type="text" name="name" id="id_name" placeholder="Enter your full name" class="w-full">
            </div>

            <div>
              <label for="id_organization" class="font-pixel text-xs text-light block mb-2 crt-glow-sm">
                College/Organization <span class="text-light/40">(Optional)</span>
              </label>
              <input type="text" name="organization" id="id_organization" placeholder="Your college or organization"
                class="w-full">
            </div>

            <div class="flex justify-center">
              {{ form.hcaptcha }}
            </div>
          </div>

          <div class="flex gap-4 mt-8">
            <button type="button"
              class="retro-form-btn flex-1 bg-dark text-light border-light bg-opacity-40 hover:bg-opacity-60 flex items-center justify-center gap-2 back-btn">
              <i class="ph-bold ph-arrow-left text-sm"></i>
              <span>Back</span>
            </button>
            <button type="submit" id="submitBtn"
              class="retro-form-btn flex-1 bg-primary text-dark border-primary hover:bg-secondary hover:border-secondary flex items-center justify-center gap-2">
              <i class="ph-bold ph-user-plus text-sm"></i>
              <span class="button-text">Sign Up</span>
            </button>
          </div>
        </div>

        <!-- Step Indicators -->
        <div class="flex justify-center gap-3 mt-8">
          <div class="step-dot" data-step="1"></div>
          <div class="step-dot" data-step="2"></div>
          <div class="step-dot" data-step="3"></div>
        </div>
      </form>

      <!-- OR Divider (Only on step 1) -->
      <div id="googleSection" class="mt-6">
        <div class="mb-6 flex items-center">
          <div class="flex-grow h-px bg-light/20"></div>
          <span class="mx-4 font-pixel text-xs text-light/40">OR</span>
          <div class="flex-grow h-px bg-light/20"></div>
        </div>
        <div class="flex items-center justify-center">
          {% include "components/google_onetap.html" %}
        </div>
      </div>

      <!-- Footer -->
      <div class="pixel-accent-amber mt-8 mb-4"></div>
      <p class="text-light/40 text-xs text-center retro-text">
        By signing up, you agree to
        <a href="{% url 'terms_and_conditions' %}" class="text-secondary hover:underline">Terms</a> and
        <a href="{% url 'privacy_policy' %}" class="text-secondary hover:underline">Privacy</a>
      </p>
    </div>
  </div>
</div>

{% if form.errors %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    {% for field in form %}
    {% for error in field.errors %} showToast("{{ error|escapejs }}", 3000, "ERROR"); {% endfor %}
    {% endfor %}
  });
</script>
{% endif %}

<script>
  let currentStep = 1;

  function updateSteps() {
    const steps = document.querySelectorAll('.form-step');
    const dots = document.querySelectorAll('.step-dot');
    const googleSection = document.getElementById('googleSection');

    steps.forEach((step, index) => {
      if (parseInt(step.dataset.step) === currentStep) {
        step.classList.remove('hidden');
        step.dataset.active = 'true';
      } else {
        step.classList.add('hidden');
        step.dataset.active = 'false';
      }
    });

    dots.forEach((dot, index) => {
      if (parseInt(dot.dataset.step) === currentStep) {
        dot.classList.add('active');
      } else {
        dot.classList.remove('active');
      }
    });

    // Show Google section only on step 1
    if (currentStep === 1) {
      googleSection.classList.remove('hidden');
    } else {
      googleSection.classList.add('hidden');
    }
  }

  function validateEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  }

  async function checkEmail(email) {
    try {
      const response = await fetch('/check-email/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ email })
      });
      return await response.json();
    } catch (error) {
      return { exists: false };
    }
  }

  async function checkUsername(username) {
    try {
      const response = await fetch('/check-username/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ username })
      });
      return await response.json();
    } catch (error) {
      return { exists: false };
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('signup_form');
    const nextBtns = document.querySelectorAll('.next-btn');
    const backBtns = document.querySelectorAll('.back-btn');
    const togglePassword = document.getElementById('togglePassword');
    const passwordInput = document.getElementById('id_password');
    const submitBtn = document.getElementById('submitBtn');

    // Initialize
    updateSteps();

    // Next buttons
    nextBtns.forEach(btn => {
      btn.addEventListener('click', async () => {
        if (currentStep === 1) {
          const email = document.getElementById('id_email').value;
          if (!validateEmail(email)) {
            showToast('Please enter a valid email address', 3000, 'ERROR');
            return;
          }
          const emailCheck = await checkEmail(email);
          if (emailCheck.exists) {
            showToast('This email is already registered', 3000, 'ERROR');
            return;
          }
        } else if (currentStep === 2) {
          const username = document.getElementById('id_username').value;
          const password = passwordInput.value;

          if (!username || !password) {
            showToast('Please fill in all required fields', 3000, 'ERROR');
            return;
          }

          if (password.length < 8) {
            showToast('Password must be at least 8 characters', 3000, 'ERROR');
            return;
          }

          const usernameCheck = await checkUsername(username);
          if (usernameCheck.exists) {
            showToast('This username is already taken', 3000, 'ERROR');
            return;
          }
        }

        currentStep++;
        updateSteps();
      });
    });

    // Back buttons
    backBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        if (currentStep > 1) {
          currentStep--;
          updateSteps();
        }
      });
    });

    // Toggle password
    if (togglePassword) {
      togglePassword.addEventListener('click', () => {
        if (passwordInput.type === 'password') {
          passwordInput.type = 'text';
          togglePassword.classList.remove('ph-eye');
          togglePassword.classList.add('ph-eye-slash');
        } else {
          passwordInput.type = 'password';
          togglePassword.classList.remove('ph-eye-slash');
          togglePassword.classList.add('ph-eye');
        }
      });
    }

    // Form submit
    form.addEventListener('submit', (e) => {
      const captchaResponse = document.querySelector('[name="h-captcha-response"]')?.value;
      if (!captchaResponse) {
        e.preventDefault();
        showToast('Please complete the captcha', 3000, 'ERROR');
        return;
      }

      submitBtn.disabled = true;
      const icon = submitBtn.querySelector('i');
      const text = submitBtn.querySelector('.button-text');
      icon.className = 'ph-bold ph-circle-notch animate-spin text-sm';
      text.textContent = 'Creating...';
    });
  });
</script>
{% endblock content %}